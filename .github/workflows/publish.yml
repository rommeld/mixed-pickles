name: Publish to PyPI

on:
    release:
        types: [published]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always

jobs:
    test:
        name: Test before publish
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@stable
              with:
                  components: clippy
            - uses: Swatinem/rust-cache@v2
            - name: Clippy
              run: cargo clippy --all-targets --all-features -- -D warnings
            - name: Run tests
              run: cargo test --all-features

    build-wheels:
        name: Build wheels on ${{ matrix.os }}
        needs: [test]
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64
                    - os: ubuntu-latest
                      target: aarch64
                    - os: macos-latest
                      target: x86_64
                    - os: macos-latest
                      target: aarch64
                    - os: windows-latest
                      target: x86_64

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.target }}
                  args: --release --out dist
                  manylinux: auto

            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-${{ matrix.os }}-${{ matrix.target }}
                  path: dist/*.whl

    build-sdist:
        name: Build source distribution
        needs: [test]
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist

            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: sdist
                  path: dist/*.tar.gz

    publish:
        name: Publish to PyPI
        needs: [build-wheels, build-sdist]
        runs-on: ubuntu-latest

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist
                  merge-multiple: true

            - name: List distribution files
              run: ls -la dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/
                  password: ${{ secrets.PYPI_API_TOKEN }}
