name: Version Bump

on:
  push:
    branches: [main]

jobs:
  version:
    name: Bump Version
    runs-on: ubuntu-latest
    # Skip if commit is from this workflow or has [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'chore: bump version')"

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version bump type
        id: bump-type
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

          if [[ "$FIRST_LINE" =~ ^feat(\(.+\))?:|^feat: ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "Detected feature commit - will bump minor version"
          elif [[ "$FIRST_LINE" =~ ^fix(\(.+\))?:|^fix: ]]; then
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "Detected fix commit - will bump patch version"
          else
            echo "type=none" >> $GITHUB_OUTPUT
            echo "No version bump needed for this commit"
          fi

      - name: Bump version
        if: steps.bump-type.outputs.type != 'none'
        run: |
          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump based on type
          if [ "${{ steps.bump-type.outputs.type }}" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "${{ steps.bump-type.outputs.type }}" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

          # Update Cargo.toml
          sed -i "s/^version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" Cargo.toml

      - name: Update CHANGELOG.md
        if: steps.bump-type.outputs.type != 'none'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
          TODAY=$(date +%Y-%m-%d)
          BUMP_TYPE="${{ steps.bump-type.outputs.type }}"

          # Extract the description from commit message (remove prefix)
          DESCRIPTION=$(echo "$FIRST_LINE" | sed -E 's/^(feat|fix)(\([^)]+\))?:[[:space:]]*//')

          # Determine section header
          if [ "$BUMP_TYPE" = "minor" ]; then
            SECTION="Added"
          else
            SECTION="Fixed"
          fi

          # Create CHANGELOG.md if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/)," >> CHANGELOG.md
            echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Create temp file with new entry
          {
            echo "## [$NEW_VERSION] - $TODAY"
            echo ""
            echo "### $SECTION"
            echo ""
            echo "- $DESCRIPTION"
            echo ""
          } > /tmp/new_entry.md

          # Insert new entry after the header
          if grep -q "^## \[" CHANGELOG.md; then
            # There are existing version entries, insert before the first one
            LINE_NUM=$(grep -n "^## \[" CHANGELOG.md | head -1 | cut -d: -f1)
            head -n $((LINE_NUM - 1)) CHANGELOG.md > /tmp/changelog_new.md
            cat /tmp/new_entry.md >> /tmp/changelog_new.md
            tail -n +$LINE_NUM CHANGELOG.md >> /tmp/changelog_new.md
            mv /tmp/changelog_new.md CHANGELOG.md
          else
            # No existing entries, append to file
            cat /tmp/new_entry.md >> CHANGELOG.md
          fi

      - name: Commit and push version bump
        if: steps.bump-type.outputs.type != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Cargo.toml CHANGELOG.md
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git tag "v$NEW_VERSION"

          git push
          git push --tags
