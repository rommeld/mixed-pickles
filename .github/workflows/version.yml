name: Update Changelog
on:
    push:
        branches: [main]

jobs:
    changelog:
        name: Update Changelog
        runs-on: ubuntu-latest
        # Skip if commit is from automation or has [skip ci]
        if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'chore: bump version') && !contains(github.event.head_commit.message, 'chore: update changelog')"
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Determine change type
              id: change-type
              run: |
                  COMMIT_MSG="${{ github.event.head_commit.message }}"
                  FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
                  if [[ "$FIRST_LINE" =~ ^feat(\(.+\))?:|^feat: ]]; then
                    echo "type=Added" >> $GITHUB_OUTPUT
                    echo "Detected feature commit"
                  elif [[ "$FIRST_LINE" =~ ^fix(\(.+\))?:|^fix: ]]; then
                    echo "type=Fixed" >> $GITHUB_OUTPUT
                    echo "Detected fix commit"
                  elif [[ "$FIRST_LINE" =~ ^docs(\(.+\))?:|^docs: ]]; then
                    echo "type=Documentation" >> $GITHUB_OUTPUT
                    echo "Detected docs commit"
                  elif [[ "$FIRST_LINE" =~ ^perf(\(.+\))?:|^perf: ]]; then
                    echo "type=Performance" >> $GITHUB_OUTPUT
                    echo "Detected performance commit"
                  elif [[ "$FIRST_LINE" =~ ^refactor(\(.+\))?:|^refactor: ]]; then
                    echo "type=Changed" >> $GITHUB_OUTPUT
                    echo "Detected refactor commit"
                  elif [[ "$FIRST_LINE" =~ ^BREAKING[[:space:]]CHANGE:|^[a-z]+(\(.+\))?!: ]]; then
                    echo "type=Breaking" >> $GITHUB_OUTPUT
                    echo "Detected breaking change commit"
                  else
                    echo "type=none" >> $GITHUB_OUTPUT
                    echo "No changelog entry needed for this commit"
                  fi

            - name: Update CHANGELOG.md
              if: steps.change-type.outputs.type != 'none'
              run: |
                  COMMIT_MSG="${{ github.event.head_commit.message }}"
                  FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
                  CHANGE_TYPE="${{ steps.change-type.outputs.type }}"
                  COMMIT_SHA="${{ github.sha }}"
                  SHORT_SHA="${COMMIT_SHA:0:7}"

                  # Extract the description from commit message (remove prefix)
                  DESCRIPTION=$(echo "$FIRST_LINE" | sed -E 's/^[a-z]+(\([^)]+\))?!?:[[:space:]]*//')

                  # Create CHANGELOG.md if it doesn't exist
                  if [ ! -f CHANGELOG.md ]; then
                    cat > CHANGELOG.md << 'EOF'
                  # Changelog

                  All notable changes to this project will be documented in this file.


                  ## [Unreleased]

                  EOF
                  fi

                  # Ensure Unreleased section exists
                  if ! grep -q "^## \[Unreleased\]" CHANGELOG.md; then
                    # Find the first version entry or end of header
                    if grep -q "^## \[" CHANGELOG.md; then
                      LINE_NUM=$(grep -n "^## \[" CHANGELOG.md | head -1 | cut -d: -f1)
                      head -n $((LINE_NUM - 1)) CHANGELOG.md > /tmp/changelog_new.md
                      echo "## [Unreleased]" >> /tmp/changelog_new.md
                      echo "" >> /tmp/changelog_new.md
                      tail -n +$LINE_NUM CHANGELOG.md >> /tmp/changelog_new.md
                      mv /tmp/changelog_new.md CHANGELOG.md
                    else
                      echo "" >> CHANGELOG.md
                      echo "## [Unreleased]" >> CHANGELOG.md
                      echo "" >> CHANGELOG.md
                    fi
                  fi

                  # Find line number of Unreleased section
                  UNRELEASED_LINE=$(grep -n "^## \[Unreleased\]" CHANGELOG.md | cut -d: -f1)

                  # Check if the subsection already exists under Unreleased
                  # Find the next ## section to determine the boundary
                  NEXT_VERSION_LINE=$(tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md | grep -n "^## \[" | head -1 | cut -d: -f1)
                  if [ -z "$NEXT_VERSION_LINE" ]; then
                    NEXT_VERSION_LINE=99999
                  else
                    NEXT_VERSION_LINE=$((UNRELEASED_LINE + NEXT_VERSION_LINE))
                  fi

                  # Check if subsection exists within Unreleased section
                  SUBSECTION_LINE=$(awk -v start="$UNRELEASED_LINE" -v end="$NEXT_VERSION_LINE" -v section="### $CHANGE_TYPE" \
                    'NR > start && NR < end && $0 == section {print NR; exit}' CHANGELOG.md)

                  if [ -n "$SUBSECTION_LINE" ]; then
                    # Subsection exists, add entry after it
                    head -n "$SUBSECTION_LINE" CHANGELOG.md > /tmp/changelog_new.md
                    echo "" >> /tmp/changelog_new.md
                    echo "- $DESCRIPTION ($SHORT_SHA)" >> /tmp/changelog_new.md
                    tail -n +$((SUBSECTION_LINE + 1)) CHANGELOG.md | tail -n +2 >> /tmp/changelog_new.md
                    mv /tmp/changelog_new.md CHANGELOG.md
                  else
                    # Subsection doesn't exist, create it after Unreleased header
                    head -n "$UNRELEASED_LINE" CHANGELOG.md > /tmp/changelog_new.md
                    echo "" >> /tmp/changelog_new.md
                    echo "### $CHANGE_TYPE" >> /tmp/changelog_new.md
                    echo "" >> /tmp/changelog_new.md
                    echo "- $DESCRIPTION ($SHORT_SHA)" >> /tmp/changelog_new.md
                    tail -n +$((UNRELEASED_LINE + 1)) CHANGELOG.md >> /tmp/changelog_new.md
                    mv /tmp/changelog_new.md CHANGELOG.md
                  fi

            - name: Commit changelog update
              if: steps.change-type.outputs.type != 'none'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Only commit if there are changes
                  if git diff --quiet CHANGELOG.md; then
                    echo "No changes to commit"
                    exit 0
                  fi

                  git add CHANGELOG.md
                  git commit -m "chore: update changelog [skip ci]"
                  git push
